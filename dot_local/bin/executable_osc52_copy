#!/usr/bin/env fish

set -l pty
if set -q TMUX
    set pty (tmux display -p '#{pane_tty}')
else
    set pty (tty)
end

if test "$pty" = "not a tty"
    echo "Error: not a tty" >&2
    exit 1
end

set -l contents $argv
set -l osc_prefix
if set -q TMUX
    if set -q SSH_CONNECTION
        set osc_prefix "\x1bPtmux;\x1b\x1bPtmux;\x1b\x1b\x1b\x1b"
    else
        set osc_prefix "\x1bPtmux;\x1b\x1b"
    end
else
    set osc_prefix "\x1b"
end
set -l osc_suffix
if set -q TMUX
    if set -q SSH_CONNECTION
        set osc_suffix '\a\x1b\x1b\\\\\x1b\\'
    else
        set osc_suffix '\a\x1b\\'
    end
else
    set osc_suffix '\x1b\\'
end
set -l serialized_contents (echo -n $contents | base64 | tr -d '\r\n')
echo -ne "$osc_prefix]52;c;$serialized_contents$osc_suffix" >$pty
